---
- name: VM Monthly System Audit
  hosts: "{{ target_hosts }}"
  become: yes
  gather_facts: yes

  tasks:
    - name: Collect Storage and Network Info
      shell: |
        echo "--- STORAGE (df -h) ---"
        df -h -x tmpfs -x devtmpfs
        echo -e "\n--- NETWORK (IP) ---"
        ip -brief addr
      register: custom_metrics

    - name: Generate Nice HTML Report directly
      delegate_to: localhost
      become: no # THIS IS THE FIX: Disable sudo for the local container
      run_once: true
      copy:
        dest: "/tmp/azure_audit_{{ ansible_date_time.date }}.html"
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <style>
                  body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 30px; }
                  .card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-top: 5px solid #0078d4; }
                  h1 { color: #0078d4; text-align: center; }
                  pre { background: #282c34; color: #abb2bf; padding: 15px; border-radius: 5px; font-size: 13px; }
              </style>
          </head>
          <body>
              <h1>Monthly Audit Report: {{ ansible_date_time.date }}</h1>
              {% for host in groups['all'] %}
                {% if hostvars[host]['custom_metrics'] is defined %}
                <div class="card">
                    <h2>Host: {{ hostvars[host]['ansible_hostname'] | default(host) }}</h2>
                    <p><strong>OS:</strong> {{ hostvars[host]['ansible_distribution'] }} {{ hostvars[host]['ansible_distribution_version'] }}</p>
                    <pre>{{ hostvars[host]['custom_metrics']['stdout'] }}</pre>
                </div>
                {% endif %}
              {% endfor %}
          </body>
          </html>

    - name: Read Report Content for Console
      delegate_to: localhost
      become: no # THIS IS THE FIX: Disable sudo for the local container
      run_once: true
      command: "cat /tmp/azure_audit_{{ ansible_date_time.date }}.html"
      register: html_output

    - name: Display HTML Code
      debug:
        msg: "COPY THE CODE BELOW AND SAVE AS .HTML FILE: \n\n {{ html_output.stdout }}"
