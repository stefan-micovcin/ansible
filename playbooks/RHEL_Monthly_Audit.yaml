---
- name: VM Monthly System Audit
  hosts: "{{ target_hosts }}"
  become: yes
  gather_facts: yes

  tasks:
    - name: Collect Storage and Network Info
      shell: |
        echo "--- STORAGE (df -h) ---"
        df -h -x tmpfs -x devtmpfs
        echo -e "\n--- NETWORK (IP) ---"
        ip -brief addr
      register: custom_metrics

    # NOW we create the template, because 'custom_metrics' now exists
    - name: Create the HTML template on the controller
      delegate_to: localhost
      run_once: true
      copy:
        dest: "/tmp/audit_report.j2"
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <title>Azure Audit Report</title>
              <style>
                  body { font-family: sans-serif; background: #f4f4f4; padding: 20px; }
                  .card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                  h1 { color: #0078d4; border-bottom: 4px solid #0078d4; padding-bottom: 10px; }
                  h2 { color: #333; }
                  pre { background: #282c34; color: #abb2bf; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 14px; }
                  .footer { font-size: 12px; color: #666; text-align: center; margin-top: 20px; }
              </style>
          </head>
          <body>
              <h1>Monthly System Audit: {{ ansible_date_time.date }}</h1>
              {% for host in groups['all'] %}
              <div class="card">
                  <h2>Host: {{ hostvars[host]['ansible_hostname'] }} ({{ hostvars[host]['ansible_default_ipv4']['address'] }})</h2>
                  <p><strong>OS:</strong> {{ hostvars[host]['ansible_distribution'] }} {{ hostvars[host]['ansible_distribution_version'] }}</p>
                  <pre>{{ hostvars[host]['custom_metrics']['stdout'] }}</pre>
              </div>
              {% endfor %}
              <div class="footer">Generated by Red Hat Ansible Automation Platform on Azure</div>
          </body>
          </html>

    - name: Generate HTML Report
      delegate_to: localhost
      run_once: true
      ansible.builtin.template:
        src: "/tmp/audit_report.j2"
        dest: "/tmp/azure_audit_{{ ansible_date_time.date }}.html"

    - name: Log Report Location
      debug:
        msg: >
          Success! The HTML report has been generated at:
          /tmp/azure_audit_{{ ansible_date_time.date }}.html
