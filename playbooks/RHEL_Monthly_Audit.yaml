---
- name: VM Monthly System Audit
  hosts: "{{ target_hosts | default('all') }}"
  become: yes
  gather_facts: yes

  tasks:
    - name: Collect Storage and Network Info
      shell: |
        echo "--- STORAGE (df -h) ---"
        df -h -x tmpfs -x devtmpfs
        echo -e "\n--- NETWORK (IP) ---"
        ip -brief addr
      register: custom_metrics

    - name: Generate HTML Report
      delegate_to: localhost
      run_once: true
      ansible.builtin.template:
        src: audit_report.j2
        dest: "/tmp/azure_audit_{{ ansible_date_time.date }}.html"

    - name: Log Report Location
      debug:
        msg: "The report has been generated on the controller at /tmp/azure_audit_{
