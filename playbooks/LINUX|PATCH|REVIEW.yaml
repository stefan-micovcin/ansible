---
- name: AWS EC2 Patch Review List
  hosts: "{{ pickup_hosts | default(omit) }}"
  become: true
  gather_facts: yes

  tasks:
    - name: Get list of available updates
      ansible.builtin.dnf:
        list: updates
        update_cache: yes
      register: patch_check

    - name: Format update list for display
      ansible.builtin.set_fact:
        update_summary: >-
          {%- for pkg in patch_check.results -%}
          {{ pkg.name }}.{{ pkg.arch }} ({{ pkg.version }})
          {% if not loop.last %}, {% endif %}
          {%- endfor -%}

    - name: Display Patch Review Summary
      ansible.builtin.debug:
        msg: 
          - "SYSTEM: {{ ansible_hostname }}"
          - "TOTAL UPDATES: {{ patch_check.results | length }}"
          - "PACKAGES TO BE UPDATED:"
          - "{{ update_summary.split(', ') }}"

    - name: Check if critical updates exist
      ansible.builtin.debug:
        msg: "WARNING: High number of updates pending!"
      when: patch_check.results | length > 50
