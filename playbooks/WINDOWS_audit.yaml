
---
- name: Windows VM System Audit
  hosts: "{{ target_hosts }}"
 
  gather_facts: false
  vars:
    ansible_connection: winrm
    ansible_port: 5986
    ansible_winrm_transport: ntlm
    ansible_winrm_server_cert_validation: ignore
 
  collections:
    - ansible.windows

  tasks:
    - name: Get Windows system metrics
     
      ansible.windows.win_shell: |
        Write-Host "--- Uptime ---"
        $os = Get-CimInstance Win32_OperatingSystem
        $uptime = (Get-Date) - $os.LastBootUpTime
        Write-Host "Days: $($uptime.Days) Hours: $($uptime.Hours) Minutes: $($uptime.Minutes)"
        
        Write-Host "`n--- OS Version ---"
        $os | Select-Object Caption, Version, OSArchitecture | Out-String
        
        Write-Host "`n--- Disk Space ---"
        Get-CimInstance Win32_LogicalDisk -Filter "DriveType=3" | 
          Select-Object DeviceID, 
          @{Name="FreeGB";Expression={[math]::Round($_.FreeSpace/1GB,2)}}, 
          @{Name="SizeGB";Expression={[math]::Round($_.Size/1GB,2)}} | Out-String
        
        Write-Host "`n--- IP Addresses ---"
        Get-NetIPAddress -AddressFamily IPv4 | 
          Select-Object InterfaceAlias, IPAddress | Out-String
      register: win_audit_output

    - name: Display Windows audit results
      ansible.builtin.debug:
        msg: "{{ win_audit_output.stdout_lines }}"
